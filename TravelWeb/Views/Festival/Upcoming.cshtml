@model List<TravelWeb.Models.Festival>
@{
    ViewData["Title"] = "Lễ hội sắp diễn ra";
    var currentPage = ViewBag.CurrentPage ?? 1;
    var totalPages = ViewBag.TotalPages ?? 1;
    var totalItems = ViewBag.TotalItems ?? 0;
}

<h2 class="text-center mb-4 text-success">📅 Lễ hội sắp diễn ra trong năm</h2>

@if (!Model.Any())
{
    <div class="card border-0 shadow-sm mx-auto" style="max-width:720px;">
        <div class="card-body text-center">
            <div class="display-6 mb-2">🌤️</div>
            <p class="text-muted mb-0">Hiện chưa có lễ hội sắp tới trong thời gian gần đây.</p>
        </div>
    </div>
}
else
{
    <div class="alert alert-info small">
        Hiển thị @((currentPage - 1) * 6 + 1) - @Math.Min(currentPage * 6, totalItems) trong tổng số @totalItems lễ hội sắp diễn ra. Sắp xếp theo ngày bắt đầu gần nhất.
    </div>
    <div class="row">
        @foreach (var fest in Model)
        {
            <div class="col-md-4 mb-4">
                @await Html.PartialAsync("_FestivalCard", fest)
            </div>
        }
    </div>
    
    @if (totalPages > 1)
    {
        <div class="pagination-container">
            <ul class="pagination">
                @if (currentPage > 1)
                {
                    <li class="page-item">
                        <a class="page-link" href="@Url.Action("Upcoming", new { page = 1 })">Đầu</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="@Url.Action("Upcoming", new { page = currentPage - 1 })">Trước</a>
                    </li>
                }
                
                @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                {
                    <li class="page-item @(i == currentPage ? "active" : "")">
                        <a class="page-link" href="@Url.Action("Upcoming", new { page = i })">@i</a>
                    </li>
                }
                
                @if (currentPage < totalPages)
                {
                    <li class="page-item">
                        <a class="page-link" href="@Url.Action("Upcoming", new { page = currentPage + 1 })">Sau</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="@Url.Action("Upcoming", new { page = totalPages })">Cuối</a>
                    </li>
                }
            </ul>
            <div class="pagination-info">
                Trang @currentPage / @totalPages
            </div>
        </div>
    }
}

@section Scripts{
<script>
    // Image carousel functions (same as Index page)
    function nextImage(carouselId) {
        const carousel = document.querySelector(`[data-carousel-id="${carouselId}"]`);
        if (!carousel) return;
        
        const images = carousel.querySelectorAll('img');
        const indicators = carousel.querySelectorAll('.carousel-indicator');
        const currentIndex = Array.from(images).findIndex(img => img.classList.contains('active'));
        const nextIndex = (currentIndex + 1) % images.length;
        
        // Hide current image
        images[currentIndex].classList.remove('active');
        indicators[currentIndex].classList.remove('active');
        
        // Show next image
        images[nextIndex].classList.add('active');
        indicators[nextIndex].classList.add('active');
    }
    
    function previousImage(carouselId) {
        const carousel = document.querySelector(`[data-carousel-id="${carouselId}"]`);
        if (!carousel) return;
        
        const images = carousel.querySelectorAll('img');
        const indicators = carousel.querySelectorAll('.carousel-indicator');
        const currentIndex = Array.from(images).findIndex(img => img.classList.contains('active'));
        const prevIndex = currentIndex === 0 ? images.length - 1 : currentIndex - 1;
        
        // Hide current image
        images[currentIndex].classList.remove('active');
        indicators[currentIndex].classList.remove('active');
        
        // Show previous image
        images[prevIndex].classList.add('active');
        indicators[prevIndex].classList.add('active');
    }
    
    function goToImage(carouselId, index) {
        const carousel = document.querySelector(`[data-carousel-id="${carouselId}"]`);
        if (!carousel) return;
        
        const images = carousel.querySelectorAll('img');
        const indicators = carousel.querySelectorAll('.carousel-indicator');
        
        // Hide all images
        images.forEach(img => img.classList.remove('active'));
        indicators.forEach(indicator => indicator.classList.remove('active'));
        
        // Show selected image
        images[index].classList.add('active');
        indicators[index].classList.add('active');
    }
</script>
}
