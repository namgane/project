@model TravelWeb.Models.VirtualTour
@{
    ViewData["Title"] = "Thêm Virtual Tour";
    var lat = ViewBag.Lat;
    var lng = ViewBag.Lng;
}

<h2>@ViewData["Title"]</h2>
<hr />

<div class="row">
    <div class="col-md-8">
        <div class="alert alert-info">
            📍 Vị trí đã chọn: <strong>Lat: @lat, Lng: @lng</strong>
        </div>

        <form asp-action="Create" method="post">
            <input type="hidden" name="lat" value="@lat" />
            <input type="hidden" name="lng" value="@lng" />

            <div asp-validation-summary="All" class="text-danger"></div>

            <div class="form-group mb-3">
                <label for="StreetViewLink" class="control-label">Link Google Street View</label>
                <input name="StreetViewLink" id="linkInput" class="form-control" placeholder="Dán link nhúng từ Google Maps (phải có /embed)" required />
                <span class="text-danger" id="linkError"></span>
                <small class="form-text text-muted">
                    <strong>Hướng dẫn lấy link:</strong><br>
                    1️⃣ Truy cập Google Maps > Tìm địa điểm<br>
                    2️⃣ Nhấp chuột phải > "Share or embed map"<br>
                    3️⃣ Tab "Embed a map" > Copy HTML<br>
                    4️⃣ Dán vào ô trên (tự động trích xuất link)
                </small>
            </div>

            <div id="preview" style="display:none; margin-top:15px;">
                <h5>🔍 Xem trước:</h5>
                <iframe id="previewFrame" width="100%" height="400" style="border:0;" allowfullscreen loading="lazy"></iframe>
            </div>

            <div class="form-group mt-4">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> Lưu Virtual Tour
                </button>
                <button type="button" class="btn btn-secondary" onclick="history.back()">
                    <i class="bi bi-arrow-left"></i> Quay lại Map
                </button>
            </div>
        </form>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                💡 Gợi ý
            </div>
            <div class="card-body">
                <p>Bạn có thể tìm các địa điểm đẹp trên Google Maps Street View:</p>
                <ul>
                    <li>Chùa Một Cột, Hà Nội</li>
                    <li>Cầu Rồng, Đà Nẵng</li>
                    <li>Nhà Thờ Đức Bà, TP.HCM</li>
                    <li>Vịnh Hạ Long</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
                const input = document.getElementById("linkInput");
                const previewDiv = document.getElementById("preview");
        const previewFrame = document.getElementById("previewFrame");

                // Hàm extract URL từ iframe hoặc text
                function extractUrl(text) {
                    text = text.trim();

                    // Nếu là thẻ iframe, lấy src
                    const srcMatch = text.match(/src=["']([^"']+)["']/i);
                    if (srcMatch && srcMatch[1]) {
                        return srcMatch[1];
                    }

                    // Nếu đã là URL, trả về luôn
                    if (text.startsWith('http')) {
                        return text;
                    }

                    return text;
                }

                // Xử lý khi nhập/paste
                function handleInput() {
                    let link = extractUrl(input.value);

                    // Cập nhật lại input với URL đã extract
                    if (link !== input.value) {
                        input.value = link;
                    }

                    if (link.includes("embed")) {
                        previewFrame.src = link;
                        previewDiv.style.display = "block";
                    } else {
                        previewDiv.style.display = "none";
                    }
                }

                input.addEventListener("input", handleInput);
                input.addEventListener("paste", function(e) {
                    setTimeout(handleInput, 100);
                });
    </script>
}